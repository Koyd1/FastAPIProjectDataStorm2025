# Анализ аномалий на FastAPI

В репозитории находится веб-приложение на FastAPI, которое использует заранее обученную модель LightGBM (`multiclass_anomaly_model.pkl`) для классификации транзакций по типам аномалий. Приложение позволяет:

- загрузить произвольный CSV со сводом транзакций и получить статистику по предсказанным классам;
- посмотреть средние вероятности по классам и (при наличии колонки `anomaly_type`) метрики качества;
- задать признаки одной транзакции вручную через форму с выпадающими списками или отправить CSV с единственной записью и получить детальный прогноз (тип аномалии, вероятности, флаг подозрительности).

## Требования

- Python 3.12+
- Установленные зависимости (см. ниже)
- Файл модели `multiclass_anomaly_model.pkl` в корне проекта

## Установка

1. При необходимости создайте виртуальное окружение:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
   Если файла `requirements.txt` нет, установите необходимые пакеты вручную:
   ```bash
   pip install fastapi uvicorn lightgbm pandas seaborn scikit-learn matplotlib joblib jinja2
   ```

3. Убедитесь, что в каталоге проекта присутствует файл модели `multiclass_anomaly_model.pkl`. Он загружается автоматически при старте приложения.

## Запуск приложения

```bash
uvicorn index:app --reload
```

По умолчанию интерфейс будет доступен по адресу <http://127.0.0.1:8000/>.

## Использование

### Анализ набора транзакций

1. Откройте главную страницу.
2. Загрузите CSV. Приложение автоматически подставит значения по умолчанию для отсутствующих признаков и покажет:
   - превью первых 10 строк с колонками `predicted_anomaly` и `is_suspicious`;
   - распределение предсказанных классов;
   - средние вероятности по классам;
   - при наличии `anomaly_type` — отчёт классификации и confusion matrix.
3. После анализа выпадающие списки в форме одиночного прогноза заполнятся типовыми значениями из вашего набора.

### Прогноз для одной записи

Есть два варианта:

1. **Форма** — выберите значения признаков в карточке «Прогноз для одной транзакции» и нажмите «Получить прогноз». Часть полей отмечена бэйджем «топ», если они входят в десятку наиболее важных признаков модели.
2. **CSV** — используйте альтернативную форму и загрузите файл с единственной строкой (заголовок + одна запись).

В ответе вы увидите:
- предсказанный класс аномалии;
- вероятность выбранного класса и список вероятностей по всем классам;
- флаг подозрительности (бинарный вывод: «Да» если класс отличается от `NORMAL`);
- сообщения о нормализации данных (например, если какие-то значения были заменены на значения по умолчанию).

## Структура проекта

- `index.py` — основной код FastAPI-приложения, логика загрузки модели, препроцессинга и предсказаний.
- `templates/index.html` — Jinja2-шаблон веб-интерфейса.
- `multiclass_anomaly_model.pkl` — сохранённая модель LightGBM.

## Полезные заметки

- Модель обучалась в среде scikit-learn 1.6.1. При запуске на других версиях может появляться предупреждение о несовпадении версий — убедитесь, что используете совместимую версию библиотеки.
- Для корректных предсказаний у CSV-файлов должны быть заголовки столбцов. Отсутствующие признаки будут заполнены «эталонными» значениями из `DEFAULT_RECORD`.
- Флаг подозрительности рассчитывается как `1 − P(NORMAL)`, то есть вероятность любой аномалии.

## Лицензия

Добавьте сюда информацию о лицензии проекта, либо удалите раздел при необходимости.

