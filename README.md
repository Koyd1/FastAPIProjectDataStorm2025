# Анализ аномалий на FastAPI

В репозитории находится веб-приложение на FastAPI, которое использует заранее обученную модель LightGBM (`models/lgbm_anomaly_multi.pkl`) и набор метаданных (`models/lgbm_anomaly_meta.pkl`) для классификации транзакций по типам аномалий. Приложение позволяет:

- загрузить произвольный CSV со сводом транзакций и получить статистику по предсказанным классам;
- посмотреть средние вероятности по классам и (при наличии колонки `anomaly_type`) метрики качества;
- задать признаки одной транзакции вручную через форму с выпадающими списками или отправить CSV с единственной записью и получить детальный прогноз (тип аномалии, вероятности, флаг подозрительности).
- сохранять обезличенные версии загруженных датасетов в Supabase и строить глобальные кластеры Random Forest в реальном времени по всей истории загрузок.

## Требования
- Python 3.12+
- Установленные зависимости (см. ниже)
- Файлы модели и метаданных: `models/lgbm_anomaly_multi.pkl` и `models/lgbm_anomaly_meta.pkl`
- (опционально) Доступ к проекту Supabase для хранения истории загрузок.

## Установка

1. При необходимости создайте виртуальное окружение:
   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
   Если файла `requirements.txt` нет, установите необходимые пакеты вручную:
   ```bash
   pip install fastapi uvicorn lightgbm pandas seaborn scikit-learn matplotlib joblib jinja2 supabase
   ```

3. Установите фронтенд-зависимости и соберите Tailwind CSS:
   ```bash
   npm install
   npm run build:css
   ```
   Для разработки интерфейса удобна команда `npm run watch:css`, которая пересобирает стили при изменении шаблонов.
4. Скопируйте `.env.example` в `.env` и заполните переменные (см. ниже), если планируете использовать Supabase.
5. Убедитесь, что в каталоге `models/` лежат файлы `lgbm_anomaly_multi.pkl` и `lgbm_anomaly_meta.pkl`. Они загружаются автоматически при старте приложения.

## Запуск приложения

```bash
uvicorn main:app --reload
```

По умолчанию интерфейс будет доступен по адресу <http://127.0.0.1:8000/>.

## Настройка через переменные окружения

Приложение можно адаптировать без правки кода, передавая переменные окружения перед запуском `uvicorn`:

- `MODEL_DIR` — каталог со всеми моделями (по умолчанию `./models`).
- `MODEL_FILENAME` / `MODEL_PATH` — имя файла или абсолютный путь к модели (`lgbm_anomaly_multi.pkl`).
- `MODEL_METADATA_FILENAME` / `MODEL_METADATA_PATH` — имя или путь к файлу метаданных (`lgbm_anomaly_meta.pkl`).
- `TEMPLATE_DIR` — путь к директории с шаблонами (по умолчанию `./templates`).
- `PREVIEW_ROWS` — количество строк предпросмотра в отчёте (по умолчанию `10`).
- `TOP_FEATURE_BADGE_COUNT` — сколько признаков помечать бейджем «топ» в форме (по умолчанию `10`).
- `TOP_FEATURE_LIST_COUNT` — сколько признаков выводить в списке важности (по умолчанию `15`).
- `SUPABASE_URL` — URL проекта Supabase.
- `SUPABASE_SERVICE_ROLE_KEY` — ключ с правами записи (используйте service role или отдельный ключ с ограниченными правами).
- `SUPABASE_BUCKET` — имя бакета Supabase Storage, в который будут складываться обезличенные CSV (по умолчанию `anomaly-uploads`).
- `SUPABASE_TABLE` — таблица для метаданных о загрузках (по умолчанию `anomaly_uploads`).
- `DATABASE_URL` — (опционально) строка подключения к Postgres Supabase; если указана, приложение будет писать метаданные напрямую через `psycopg2`.

Пример запуска с указанием каталога моделей:

```bash
MODEL_DIR=/opt/models uvicorn index:app --reload
```

## Исторические визуализации и Supabase
При успешной настройке Supabase каждое загруженное CSV (плюс предсказанные моделью столбцы) сохраняется в бакете. 
Если тот же файл загружается повторно, система не запускает повторный анализ — данные и результаты визуализаций мгновенно подгружаются из БД.
Перед сохранением данные очищаются от чувствительных полей (transaction_id, customer_id, timestamp и т.д.), а обезличенные записи добавляются в общую историю анализов.

На основе объединённых данных строятся следующие визуализации:
 - Базовые общие определения данны (классы и количество запсией);
 - 3D PCA-кластеры (распределение записей по трём главным компонентам (Principal Components) с выделением нормальных и аномальных транзакций);
 - Барчарт важности признаков (Random Forest Feature Importance);
 - Тепловая карта корреляций признаков. Высокие положительные или отрицательные корреляции выделяются цветом, помогая выявить зависимости между параметрами;
 - KDE-график распределения сумм транзакций (amount_mdl). 

История анализа хранится и локально в памяти текущего процесса.

## Использование

### Анализ набора транзакций

1. Откройте главную страницу.
2. Загрузите CSV. Приложение автоматически подставит значения по умолчанию для отсутствующих признаков и покажет:
   - превью первых 10 строк с колонками `predicted_anomaly` и `is_suspicious`;
   - распределение предсказанных классов;
   - средние вероятности по классам;
   - при наличии `anomaly_type` — отчёт классификации и confusion matrix.
3. После анализа выпадающие списки в форме одиночного прогноза заполнятся типовыми значениями из вашего набора.

### Прогноз для одной записи

Есть два варианта:

1. **Форма** — выберите значения признаков в карточке «Прогноз для одной транзакции» и нажмите «Получить прогноз». Часть полей отмечена бэйджем «топ», если они входят в десятку наиболее важных признаков модели.
2. **CSV** — используйте альтернативную форму и загрузите файл с единственной строкой (заголовок + одна запись).

В ответе вы увидите:
- предсказанный класс аномалии;
- вероятность выбранного класса и список вероятностей по всем классам;
- флаг подозрительности (бинарный вывод: «Да» если класс отличается от `NORMAL`);
- сообщения о нормализации данных (например, если какие-то значения были заменены на значения по умолчанию).

## Структура проекта

- `index.py` — точка входа FastAPI с конфигурацией, загрузкой модели из `models/` и хранилищем состояния.
- `app/` — модульная логика (настройки, пайплайн предобработки, Supabase, маршруты).
- `templates/index.html` — обновлённый Jinja2-шаблон интерфейса с секциями для свода, визуализаций и одиночного прогноза.
- `models/lgbm_anomaly_multi.pkl` — сохранённая модель LightGBM.
- `models/lgbm_anomaly_meta.pkl` — метаданные с описанием признаков и классов модели.
- `.env.example` — пример конфигурации окружения (в том числе Supabase).

## Полезные заметки

- Модель обучалась в среде scikit-learn 1.6.1. При запуске на других версиях может появляться предупреждение о несовпадении версий — убедитесь, что используете совместимую версию библиотеки.
- Для корректных предсказаний у CSV-файлов должны быть заголовки столбцов. Отсутствующие признаки будут заполнены «эталонными» значениями из `DEFAULT_RECORD`.
- Флаг подозрительности рассчитывается как `1 − P(NORMAL)`, то есть вероятность любой аномалии.
- При включённой Supabase-интеграции в хранилище отправляются только обезличенные данные без ключевых идентификаторов.
