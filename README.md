# FastAPI-анализ аномалий

Веб-приложение на FastAPI использует обученную модель LightGBM (`models/lgbm_anomaly_multi.pkl`) и метаданные (`models/lgbm_anomaly_meta.pkl`) для проверки транзакций на признаки аномалий. Интерфейс позволяет загрузить CSV, получить сводку по классам, выполнить одиночный прогноз и, при необходимости, отправлять обезличенные данные в Supabase.

## Что умеет
- Анализирует CSV-файлы: считает распределение классов, выводит средние вероятности, показывает качество при наличии `anomaly_type`.
- Формирует единичный прогноз из формы или CSV с одной записью и возвращает тип аномалии, вероятности и флаг подозрительности.
- Запоминает обработанные наборы, строит визуализации и может сохранять историю загрузок в Supabase для глобальных отчётов.

## Быстрый старт
1. Установите зависимости:
   ```bash
   python -m venv .venv && source .venv/bin/activate  # Windows: .venv\Scripts\activate
   pip install -r requirements.txt
   npm install && npm run build:css  # для Tailwind
   ```
2. Скопируйте `.env.example` в `.env` и при необходимости заполните Supabase-конфигурацию.
3. Поместите файлы модели в директорию `models/`.
4. Запустите приложение:
   ```bash
   uvicorn main:app --env-file .env --reload  # или просто --reload
   ```
   По умолчанию интерфейс открыт на <http://127.0.0.1:8000/>.

## Настройки через переменные окружения
- `MODEL_DIR`, `MODEL_FILENAME`, `MODEL_METADATA_FILENAME` — путь к основной модели и метаданным.
- `PREVIEW_ROWS`, `TOP_FEATURE_BADGE_COUNT`, `TOP_FEATURE_LIST_COUNT` — контроль предпросмотра и подсветки важных признаков.
- `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_BUCKET`, `SUPABASE_TABLE`, `DATABASE_URL` — параметры интеграции с Supabase (опционально).

## Структура проекта
- `main.py` — точка входа FastAPI.
- `app/` — бизнес-логика, маршруты, аналитика и интеграции.
- `templates/index.html` — Jinja2-шаблон интерфейса.
- `models/` — сериализованные артефакты LightGBM.
- `static/`, `assets/` — собранные стили и вспомогательные файлы фронтенда.

## Полезно знать
- CSV должен содержать заголовки; отсутствующие признаки заполняются эталонными значениями.
- Supabase хранит только обезличенные данные и позволяет строить агрегированные визуализации.
- При несовпадении версий scikit-learn возможны предупреждения — используйте 1.6.1 или совместимую версию.
