{% extends "base.html" %}
{% from "macros/forms.html" import file_upload %}

{% block title %}Анализ аномалий в транзакциях{% endblock %}

{% block body %}
<div class="layout">
    <header class="masthead">
        <div class="masthead__intro">
            <h1>Цифровой анализ аномалий</h1>
            <p>Загрузите CSV, чтобы получить сводку по аномальным транзакциям и построить мгновенный прогноз для единичных операций.</p>
        </div>
        <div class="masthead__status">
            {% if model_ready %}
                <span class="tag status-success">Модель загружена</span>
            {% else %}
                <span class="tag status-warn">Модель не готова</span>
            {% endif %}
            {% if filename %}
                <span class="tag file">Последний файл: {{ filename }}</span>
            {% endif %}
        </div>
    </header>

    <main class="content">
        <section class="card card-accent" id="upload">
            <div class="section-heading" style="padding-bottom: 10px;">
                <h2>Загрузите первоначальный набор транзакций</h2>
                <p>Формат — CSV. Отсутствующие признаки будут заполнены автоматически, после чего появится интерактивный отчёт.<br></p>
            </div>
            <form method="post" action="/analyze" enctype="multipart/form-data" class="upload-form">
                {{ file_upload("fileInput", "file", "fileName") }}
                <button class="button" type="submit">Загрузить и проанализировать</button>
            </form>
            <!-- <form method="get" action="/export-pdf">
                <button class="button" type="submit">Экспорт в PDF</button>
            </form> -->
            {% if error %}
                <div class="alert error">{{ error }}</div>
            {% endif %}
            {% if notifications %}
                <div class="stack">
                    {% for note in notifications %}
                        <div class="alert info">{{ note }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        </section>

        <section class="card" id="single-upload">
            <div class="section-heading" style="
    padding-bottom: 10px;">
                <h2>Быстрый прогноз по одной записи</h2>
                <p>Передайте транзакцию через CSV или заполните форму вручную — ответ появится сразу.</p>
            </div>

            <div class="quick-stack" style="padding-bottom: 5px;">
                <article class="quick-card quick-card--csv">
                    <div class="quick-card__header">
                        <span class="quick-card__eyebrow">CSV</span>
                        <h3 class="quick-card__title">Загрузка одной транзакции</h3>
                    </div>
                    <p class="quick-text">Файл должен содержать полный набор признаков. Поддерживаются разделители «,» и «;».</p>
                    <form method="post" action="/predict" enctype="multipart/form-data" class="upload-form quick-upload">
                        {{ file_upload("singleFileInput", "file", "singleFileName") }}
                        <button class="button quick-upload__submit" type="submit">Проанализировать CSV</button>
                    </form>
                    <ul class="quick-hints quick-hints--bordered">
                        <li><span class="quick-dot"></span>Названия колонок должны совпадать с обучающим набором.</li>
                        <li><span class="quick-dot"></span>Если данных нет, оставьте ячейку пустой — модель заполнит пропуски.</li>
                        <li><span class="quick-dot"></span>Результат отображается ниже и не сохраняется автоматически.</li>
                    </ul>
                                            <form method="get" action="/export-pdf" class="mt-6 flex justify-end">
                            <input type="hidden" name="scope" value="single">
                            <button class="button" type="submit">Экспорт прогноза в PDF</button>
                        </form>
                </article>

                {% if model_ready %}
                    {% set open_manual_form = form_values or prediction_error or (prediction and prediction.source == 'form') %}
                    <details class="quick-manual" {% if open_manual_form %}open{% endif %}>
                        <summary>
                            <div class="quick-manual__summary">
                                <div>
                                    <span class="quick-card__eyebrow">Форма</span>
                                    <h3 class="quick-card__title">Ручной ввод признаков</h3>
                                </div>
                                <span class="quick-manual__hint">
                                    {% if open_manual_form %}свернуть{% else %}раскройте форму{% endif %}
                                </span>
                            </div>
                        </summary>
                        <p class="summary-subtext">Признаки, наиболее значимые для модели, отмечены бейджем «топ».</p>
                        <div class="quick-accordion__content">
                            <form method="post" action="/predict-form" class="quick-manual__form">
                                <div class="quick-manual__grid">
                                    {% for field in input_metadata %}
                                        <div class="quick-manual__field">
                                            <label class="quick-manual__label">
                                                {{ field.name.replace('_', ' ') }}
                                                {% if field.is_top_feature %}
                                                    <span class="badge-top">топ</span>
                                                {% endif %}
                                            </label>
                                            {% if field.input_type == "select" %}
                                                <select name="{{ field.name }}">
                                                    {% for choice in field.choices %}
                                                        <option value="{{ choice.value }}" {% if choice.selected %}selected{% endif %}>{{ choice.label }}</option>
                                                    {% endfor %}
                                                </select>
                                            {% elif field.input_type == "number" %}
                                                <input type="number" name="{{ field.name }}" value="{{ field.value }}" step="{{ field.step }}" {% if field.suggestions %}list="{{ field.datalist_id }}"{% endif %}>
                                                {% if field.suggestions %}
                                                    <datalist id="{{ field.datalist_id }}">
                                                        {% for suggestion in field.suggestions %}
                                                            <option value="{{ suggestion }}"></option>
                                                        {% endfor %}
                                                    </datalist>
                                                {% endif %}
                                            {% else %}
                                                <input type="text" name="{{ field.name }}" value="{{ field.value }}" {% if field.suggestions %}list="{{ field.datalist_id }}"{% endif %}>
                                                {% if field.suggestions %}
                                                    <datalist id="{{ field.datalist_id }}">
                                                        {% for suggestion in field.suggestions %}
                                                            <option value="{{ suggestion }}"></option>
                                                        {% endfor %}
                                                    </datalist>
                                                {% endif %}
                                            {% endif %}
                                            {% if field.importance_score %}
                                                <span class="field-meta">Важность: {{ "%.2f"|format(field.importance_score) }}</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="quick-manual__actions">
                                    <button class="button quick-manual__submit" type="submit">Получить прогноз</button>
                                </div>
                            </form>
                        </div>
                    </details>
                {% else %}
                    <div class="quick-card quick-card--disabled">
                        <div class="quick-card__header">
                            <span class="quick-card__eyebrow">Форма</span>
                            <h3 class="quick-card__title">Ручной ввод недоступен</h3>
                        </div>
                        <p class="quick-text">Дождитесь загрузки модели, чтобы заполнить признаки вручную.</p>
                    </div>
                {% endif %}
            </div>

            {% if model_ready %}
                {% if prediction_error %}
                    <div class="alert error">{{ prediction_error }}</div>
                {% endif %}

                {% if prediction %}
                    <div class="card-surface">
                        <h3>Результат прогноза</h3>
                        <div class="table-wrapper table-wrapper--compact">
                            {{ prediction.preview_html | safe }}
                        </div>
                        <div class="prediction-summary">
                            <div class="prediction-overview">
                                <div class="prediction-chip">
                                    <span class="prediction-chip__label">Источник данных</span>
                                    <span class="prediction-chip__value">{% if prediction.source == 'form' %}форма{% else %}CSV{% endif %}</span>
                                </div>
                                <div class="prediction-chip">
                                    <span class="prediction-chip__label">Тип аномалии</span>
                                    <span class="prediction-chip__value">{{ prediction.anomaly_label }}</span>
                                </div>
                                <div class="prediction-chip">
                                    <span class="prediction-chip__label">Вероятность класса</span>
                                    <span class="prediction-chip__value">{{ "%.2f"|format(prediction.predicted_probability * 100) }}%</span>
                                </div>
                            </div>
                            <ul class="simple-list">
                                {% for item in prediction.anomaly_probabilities %}
                                    <li>
                                        <span>{{ item.label }}</span>
                                        <span>{{ "%.2f"|format(item.probability * 100) }}%</span>
                                    </li>
                                {% endfor %}
                            </ul>
                            {% if prediction.suspicious is not none %}
                                {% if prediction.suspicious %}
                                    <div class="alert info">Подозрительная транзакция — вероятность {{ "%.1f"|format(prediction.suspicious_probability * 100) }}%</div>
                                {% else %}
                                    <div class="alert success">Вероятность аномалии низкая — {{ "%.1f"|format((1 - prediction.suspicious_probability) * 100) }}%</div>
                                {% endif %}
                            {% else %}
                                <div class="alert info">Модель не обучена на нормальных транзакциях (класс NORMAL отсутствует).</div>
                            {% endif %}

                            {% if prediction.preprocessing_notes %}
                                {% for prep_note in prediction.preprocessing_notes %}
                                    <div class="alert info">{{ prep_note }}</div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <form method="get" action="/export-pdf" class="mt-6 flex justify-end">
                            <input type="hidden" name="scope" value="single">
                            <button class="button" type="submit">Экспорт прогноза в PDF</button>
                        </form>
                    </div>
                {% endif %}
            {% endif %}
        </section>

        {% if result %}
            <section class="card" id="dataset">
                <div class="section-heading">
                    <h2>Сводка по загруженному датасету</h2>
                    <p>Проверьте основные показатели, изучите предпросмотр и распределение предсказаний модели.</p>
                </div>

                <div class="card-surface" style="margin-bottom: 10px;">
                    <h3>Основные метрики загруженного набора</h3>
                    <div class="metric-grid">
                        <div class="metric">
                            <span>{{ result.records }} строк</span>
                        </div>
                        <div class="metric">
                            <span>{{ result.columns }}</span>
                        </div>
                        {% if result.prediction_counts %}
                            <div class="metric">
                                <span>{{ result.prediction_counts|length }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card-surface">
                    <h3>Предпросмотр данных</h3>
                    <div class="table-wrapper">
                        {{ result.preview_html | safe }}
                    </div>
                </div>

                {% if result.prediction_counts %}
                    <div class="card-surface" style="margin-top: 10px;">
                        <h3>Распределение предсказанных классов</h3>
                        <ul class="simple-list">
                            {% for label, count in result.prediction_counts.items() %}
                                <li>
                                    <span>{{ label }}</span>
                                    <span>{{ count }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if result.average_probabilities %}
                    <div class="card-surface" style="margin-bottom: 10px; margin-top: 10px;">
                        <h3>Средние вероятности по классам</h3>
                        <ul class="simple-list">
                            {% for label, prob in result.average_probabilities.items() %}
                                <li>
                                    <span>{{ label }}</span>
                                    <span>{{ "%.2f"|format(prob * 100) }}%</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if result.classification_report or result.confusion_image %}
                    <div class="card-surface">
                        <h3>Метрики качества</h3>
                        <div class="stack">
                            {% if result.classification_report %}
                                <pre>{{ result.classification_report }}</pre>
                            {% endif %}
                            {% if result.confusion_image %}
                                <img class="chart" src="data:image/png;base64,{{ result.confusion_image }}" alt="Confusion Matrix">
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </section>
        {% endif %}

        {% if importance_image or top_features %}
            <section class="card" id="features">
                <div class="section-heading">
                    <h2>Важность признаков модели</h2>
                    <p>Используйте визуализацию и рейтинг, чтобы объяснить решения модели и выявить критичные признаки.</p>
                </div>
                <div class="feature-grid">
                    {% if importance_image %}
                        <div class="card-surface">
                            <h3>Топ признаков по gain</h3>
                            <img class="chart" src="data:image/png;base64,{{ importance_image }}" alt="Feature Importance">
                        </div>
                    {% endif %}
                    {% if top_features %}
                        <div class="card-surface">
                            <h3>Рейтинг признаков</h3>
                            <ul class="simple-list">
                                {% for item in top_features %}
                                    <li>
                                        <span>{{ item.feature }}</span>
                                        <span>{{ "%.2f"|format(item.importance) }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </section>
        {% endif %}

        {% if rf_visuals %}
            <section class="card" id="global-insights">
                <div class="section-heading">
                    <h2>Кластеризация (Random Forest)</h2>
                    <p>Интерактивные инсайты по всем загруженным наборам данных. Кластеры формируются заново после каждой загрузки.</p>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <label>Объём выборки</label>
                        <span>{{ rf_visuals.sample_size }}</span>
                    </div>
                    {% if rf_visuals.class_counts %}
                        <div class="metric">
                            <label>Классы</label>
                            <span>{{ rf_visuals.class_counts|length }}</span>
                        </div>
                    {% endif %}
                </div>
                {% if rf_visuals.class_counts %}
                    <div class="card-surface" style="margin-bottom: 10px; margin-top: 10px;">
                        <h3>Распределение по классам (история)</h3>
                        <ul class="simple-list">
                            {% for label, count in rf_visuals.class_counts.items() %}
                                <li>
                                    <span>{{ label }}</span>
                                    <span>{{ count }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                <div class="feature-grid">
                    {% if rf_visuals.cluster_image_2d and False %}
                        <div class="card-surface">
                            <h3>Кластеры (PCA проекция 2Д)</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.cluster_image_2d }}" alt="Random forest clusters two demensions">
                        </div>
                    {% endif %}
                    {% if rf_visuals.cluster_image_3d %}
                        <div class="card-surface">
                            <h3>Кластеры (PCA проекция 3Д)</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.cluster_image_3d }}" alt="Random forest clusters three demensions">
                        </div>
                    {% endif %}
                    {% if rf_visuals.correlation_heatmap %}
                        <div class="card-surface">
                            <h3>Тепловая карта корреляций</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.correlation_heatmap }}" alt="Heatmap of correlations">
                        </div>
                    {% endif %}
                    {% if rf_visuals.amount_kde_plot %}
                        <div class="card-surface">
                            <h3>Оценка плотности количества</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.amount_kde_plot }}" alt="Kernel Density Estimation plot">
                        </div>
                    {% endif %}
                    {% if rf_visuals.feature_image %}
                        <div class="card-surface">
                            <h3>Важность признаков</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.feature_image }}" alt="Random forest feature importances">
                        </div>
                    {% endif %}
                </div>
            </section>
        {% endif %}
        <section class="card" id="stats-graphs">
             <div class="section-heading">
                <h2>Статистика анализируемых транзакций</h2>
                <p>Графики с различными статистическими показателями по загруженным транзакциям.</p>
            </div>
            <div class="card-surface">

                {% if stats_graphs %}
                    {% for graph in stats_graphs %}
                        <div style="margin-bottom: 20px;">
                            <h3>{{ graph.title }}</h3>
                            <img class="chart" src="data:image/png;base64,{{ graph.image_base64 }}" alt="{{ graph.title }}">
                        </div>
                    {% endfor %}
                {% else %}
                    <p>Графики будут отображены здесь после загрузки данных.</p>
                {% endif %}
            </div>
        </section>

    </main>
</div>
{% endblock %}
