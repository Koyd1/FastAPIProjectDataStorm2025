{% extends "base.html" %}
{% from "macros/forms.html" import file_upload %}

{% block title %}Анализ аномалий в транзакциях{% endblock %}

{% block body %}
<div class="layout">
    <header class="masthead">
        <div class="masthead__intro">
            <h1>Цифровой анализ аномалий</h1>
            <p>Загрузите CSV, чтобы получить сводку по аномальным транзакциям и построить мгновенный прогноз для единичных операций.</p>
        </div>
        <div class="masthead__status">
            {% if model_ready %}
                <span class="tag status-success">Модель загружена</span>
            {% else %}
                <span class="tag status-warn">Модель не готова</span>
            {% endif %}
            {% if filename %}
                <span class="tag file">Последний файл: {{ filename }}</span>
            {% endif %}
        </div>
    </header>

    <main class="content">
        <section class="card card-accent" id="upload">
            <div class="section-heading">
                <h2>1. Загрузите набор транзакций</h2>
                <p>Формат — CSV. Отсутствующие признаки будут заполнены автоматически, после чего появится интерактивный отчёт.</p>
            </div>
            <form method="post" action="/analyze" enctype="multipart/form-data" class="upload-form">
                {{ file_upload("fileInput", "file", "fileName") }}
                <button class="button" type="submit">Загрузить и проанализировать</button>
            </form>
            <form method="get" action="/export-pdf">
                <button class="button" type="submit">Экспорт в PDF</button>
            </form>
            {% if error %}
                <div class="alert error">{{ error }}</div>
            {% endif %}
            {% if notifications %}
                <div class="stack">
                    {% for note in notifications %}
                        <div class="alert info">{{ note }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        </section>

        <section class="card" id="single-upload">
            <div class="section-heading">
                <h2>2. Быстрый прогноз по одной записи</h2>
                <p>Загрузите CSV с единственной строкой, чтобы мгновенно получить классификацию и вероятности.</p>
            </div>
            <div class="stack">
                <form method="post" action="/predict" enctype="multipart/form-data" class="upload-form">
                    {{ file_upload("singleFileInput", "file", "singleFileName") }}
                    <button class="button" type="submit">Проанализировать CSV</button>
                </form>

                {% if model_ready %}
                    {% set open_manual_form = form_values or prediction_error or (prediction and prediction.source == 'form') %}
                    <details class="card-surface" {% if open_manual_form %}open{% endif %}>
                        <summary>Ручной ввод одной записи для анализа</summary>
                        <p class="summary-subtext">
                            Выберите значения признаков вручную или загрузите CSV с одной строкой.
                            Признаки с высоким вкладом отмечены как «топ».
                        </p>
                        <form method="post" action="/predict-form">
                            <div class="stack">
                                <div class="form-grid">
                                    {% for field in input_metadata %}
                                        <div class="form-field">
                                            <label>
                                                {{ field.name.replace('_', ' ') }}
                                                {% if field.is_top_feature %}
                                                    <span class="badge-top">топ</span>
                                                {% endif %}
                                            </label>
                                            {% if field.input_type == "select" %}
                                                <select name="{{ field.name }}">
                                                    {% for choice in field.choices %}
                                                        <option value="{{ choice.value }}" {% if choice.selected %}selected{% endif %}>{{ choice.label }}</option>
                                                    {% endfor %}
                                                </select>
                                            {% elif field.input_type == "number" %}
                                                <input type="number" name="{{ field.name }}" value="{{ field.value }}" step="{{ field.step }}" {% if field.suggestions %}list="{{ field.datalist_id }}"{% endif %}>
                                                {% if field.suggestions %}
                                                    <datalist id="{{ field.datalist_id }}">
                                                        {% for suggestion in field.suggestions %}
                                                            <option value="{{ suggestion }}"></option>
                                                        {% endfor %}
                                                    </datalist>
                                                {% endif %}
                                            {% else %}
                                                <input type="text" name="{{ field.name }}" value="{{ field.value }}" {% if field.suggestions %}list="{{ field.datalist_id }}"{% endif %}>
                                                {% if field.suggestions %}
                                                    <datalist id="{{ field.datalist_id }}">
                                                        {% for suggestion in field.suggestions %}
                                                            <option value="{{ suggestion }}"></option>
                                                        {% endfor %}
                                                    </datalist>
                                                {% endif %}
                                            {% endif %}
                                            {% if field.importance_score %}
                                                <span class="field-meta">Важность: {{ "%.2f"|format(field.importance_score) }}</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                                <button class="button" type="submit">Получить прогноз</button>
                            </div>
                        </form>
                    </details>

                    {% if prediction_error %}
                        <div class="alert error">{{ prediction_error }}</div>
                    {% endif %}

                    {% if prediction %}
                        <div class="card-surface">
                            <h3>Результат прогноза</h3>
                            <div class="table-wrapper table-wrapper--compact">
                                {{ prediction.preview_html | safe }}
                            </div>
                            <div class="prediction-summary">
                                <div>
                                    <strong>Источник данных:</strong> {% if prediction.source == 'form' %}форма{% else %}CSV{% endif %}
                                </div>
                                <div>
                                    <strong>Тип аномалии:</strong> {{ prediction.anomaly_label }}
                                </div>
                                <div>
                                    <strong>Вероятность класса:</strong> {{ "%.2f"|format(prediction.predicted_probability * 100) }}%
                                </div>
                                <ul class="simple-list">
                                    {% for item in prediction.anomaly_probabilities %}
                                        <li>
                                            <span>{{ item.label }}</span>
                                            <span>{{ "%.2f"|format(item.probability * 100) }}%</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                                {% if prediction.suspicious is not none %}
                                    {% if prediction.suspicious %}
                                        <div class="alert info">Подозрительная транзакция — вероятность {{ "%.1f"|format(prediction.suspicious_probability * 100) }}%</div>
                                    {% else %}
                                        <div class="alert success">Вероятность аномалии низкая — {{ "%.1f"|format((1 - prediction.suspicious_probability) * 100) }}%</div>
                                    {% endif %}
                                {% else %}
                                    <div class="alert info">Модель не обучена на нормальных транзакциях (класс NORMAL отсутствует).</div>
                                {% endif %}

                                {% if prediction.preprocessing_notes %}
                                    {% for prep_note in prediction.preprocessing_notes %}
                                        <div class="alert info">{{ prep_note }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="alert info">Модель ещё не загружена, дождитесь и попробуйте снова.</div>
                {% endif %}
            </div>
        </section>

        {% if result %}
            <section class="card" id="dataset">
                <div class="section-heading">
                    <h2>3. Сводка по загруженному датасету</h2>
                    <p>Проверьте основные показатели, изучите предпросмотр и распределение предсказаний модели.</p>
                </div>

                <div class="card-surface">
                    <h3>Основные метрики загруженного набора</h3>
                    <div class="metric-grid">
                        <div class="metric">
                            <label>Объём</label>
                            <span>{{ result.records }} строк</span>
                        </div>
                        <div class="metric">
                            <label>Признаки</label>
                            <span>{{ result.columns }}</span>
                        </div>
                        {% if result.prediction_counts %}
                            <div class="metric">
                                <label>Классы модели</label>
                                <span>{{ result.prediction_counts|length }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="card-surface">
                    <h3>Предпросмотр данных</h3>
                    <div class="table-wrapper">
                        {{ result.preview_html | safe }}
                    </div>
                </div>

                {% if result.prediction_counts %}
                    <div class="card-surface">
                        <h3>Распределение предсказанных классов</h3>
                        <ul class="simple-list">
                            {% for label, count in result.prediction_counts.items() %}
                                <li>
                                    <span>{{ label }}</span>
                                    <span>{{ count }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if result.average_probabilities %}
                    <div class="card-surface">
                        <h3>Средние вероятности по классам</h3>
                        <ul class="simple-list">
                            {% for label, prob in result.average_probabilities.items() %}
                                <li>
                                    <span>{{ label }}</span>
                                    <span>{{ "%.2f"|format(prob * 100) }}%</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if result.classification_report or result.confusion_image %}
                    <div class="card-surface">
                        <h3>Метрики качества</h3>
                        <div class="stack">
                            {% if result.classification_report %}
                                <pre>{{ result.classification_report }}</pre>
                            {% endif %}
                            {% if result.confusion_image %}
                                <img class="chart" src="data:image/png;base64,{{ result.confusion_image }}" alt="Confusion Matrix">
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </section>
        {% endif %}

        {% if importance_image or top_features %}
            <section class="card" id="features">
                <div class="section-heading">
                    <h2>4. Важность признаков модели</h2>
                    <p>Используйте визуализацию и рейтинг, чтобы объяснить решения модели и выявить критичные признаки.</p>
                </div>
                <div class="feature-grid">
                    {% if importance_image %}
                        <div class="card-surface">
                            <h3>Топ признаков по gain</h3>
                            <img class="chart" src="data:image/png;base64,{{ importance_image }}" alt="Feature Importance">
                        </div>
                    {% endif %}
                    {% if top_features %}
                        <div class="card-surface">
                            <h3>Рейтинг признаков</h3>
                            <ul class="simple-list">
                                {% for item in top_features %}
                                    <li>
                                        <span>{{ item.feature }}</span>
                                        <span>{{ "%.2f"|format(item.importance) }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                </div>
            </section>
        {% endif %}

        {% if rf_visuals %}
            <section class="card" id="global-insights">
                <div class="section-heading">
                    <h2>6. Кластеризация (Random Forest)</h2>
                    <p>Интерактивные инсайты по всем загруженным наборам данных. Кластеры формируются заново после каждой загрузки.</p>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <label>Объём выборки</label>
                        <span>{{ rf_visuals.sample_size }}</span>
                    </div>
                    {% if rf_visuals.class_counts %}
                        <div class="metric">
                            <label>Классы</label>
                            <span>{{ rf_visuals.class_counts|length }}</span>
                        </div>
                    {% endif %}
                </div>
                {% if rf_visuals.class_counts %}
                    <div class="card-surface">
                        <h3>Распределение по классам (история)</h3>
                        <ul class="simple-list">
                            {% for label, count in rf_visuals.class_counts.items() %}
                                <li>
                                    <span>{{ label }}</span>
                                    <span>{{ count }}</span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                <div class="feature-grid">
                    {% if rf_visuals.cluster_image_2d and False %}
                        <div class="card-surface">
                            <h3>Кластеры (PCA проекция 2Д)</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.cluster_image_2d }}" alt="Random forest clusters two demensions">
                        </div>
                    {% endif %}
                    {% if rf_visuals.cluster_image_3d %}
                        <div class="card-surface">
                            <h3>Кластеры (PCA проекция 3Д)</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.cluster_image_3d }}" alt="Random forest clusters three demensions">
                        </div>
                    {% endif %}
                    {% if rf_visuals.correlation_heatmap %}
                        <div class="card-surface">
                            <h3>Тепловая карта корреляций</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.correlation_heatmap }}" alt="Heatmap of correlations">
                        </div>
                    {% endif %}
                    {% if rf_visuals.amount_kde_plot %}
                        <div class="card-surface">
                            <h3>Оценка плотности количества</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.amount_kde_plot }}" alt="Kernel Density Estimation plot">
                        </div>
                    {% endif %}
                    {% if rf_visuals.feature_image %}
                        <div class="card-surface">
                            <h3>Важность признаков</h3>
                            <img class="chart" src="data:image/png;base64,{{ rf_visuals.feature_image }}" alt="Random forest feature importances">
                        </div>
                    {% endif %}
                </div>
            </section>
        {% endif %}
    </main>
</div>
{% endblock %}
